# 🔍 Charles 기반 모바일 우회 실습 - 개념 및 보안 경고 통합 정리

---

## 1. 실습 배경 및 시도한 방법

현재 상황은 다음과 같습니다:

- **nbcamp.spartacodingclub.kr**라는 사이트는 **모바일 환경에서 출석 기능 접근을 제한**하고 있습니다.
- 즉, 브라우저가 모바일 Safari인지 PC Chrome인지에 따라 기능 노출 여부가 달라집니다.
- 우리는 모바일 환경에서도 PC처럼 위장하여 출석 기능에 접근하려는 시도를 한 것입니다.

이를 위해 선택한 방식은 다음과 같습니다:

> 📦 **Charles Proxy를 이용해 모바일 요청을 중간에서 가로채고, 그 안의 정보를 조작하여 서버를 속이는 방법**

Charles는 HTTPS 트래픽을 **중간에서 복호화(해독)**하고, **HTTP Header (예: User-Agent)**를 조작할 수 있는 프록시 도구입니다.  
User-Agent는 브라우저가 서버에게 "나는 iPhone Safari야" 혹은 "나는 PC Chrome이야"라고 말하는 정체성 정보입니다.

### 🔧 비유로 보는 핵심 아이디어
> 마치 네가 패스트푸드점에서 어린이 메뉴를 시키기 싫어서  
> 키 큰 친구를 대신 보내 “난 성인이야!”라고 말하게 하는 것과 비슷합니다.  
> 서버는 ‘User-Agent’만 보고 “그래, 너 PC지”라며 출석 기능을 열어주는 셈입니다.

---

## 2. Charles Proxy 설치 시 보안 경고에 대한 이해

이 실습을 위해 Windows에 Charles를 설치할 때 다음과 같은 **UAC(사용자 계정 컨트롤)** 보안 경고가 발생합니다.

이는 다음과 같은 이유로 **정상적인 알림**입니다:

- Charles는 시스템의 네트워크 트래픽, 인증서, 루트 HTTPS 요청 등 **핵심 리소스에 접근**하는 툴이기 때문에  
  Windows가 **관리자 권한 상승 요청**과 함께 보안 경고를 띄우는 것입니다.

### ✅ Charles Proxy는 위험한가?

- **공식 웹사이트([charlesproxy.com](https://www.charlesproxy.com))에서 받은 경우 전혀 위험하지 않습니다.**
- 단, Charles는 다음과 같은 행위가 가능하므로 **악용될 경우 보안 위협이 될 수 있습니다**:
  - HTTPS 요청 복호화 (MITM 인증서 설치)
  - 로그인 정보, 세션 쿠키 등 민감한 정보 수집
  - 모바일 앱 트래픽 가로채기

👉 **도구 자체는 합법적이고 강력한 디버깅 툴**이지만, **사용자의 목적과 행위가 중요**합니다.

---

## 3. 우리가 막히게 된 원인 및 서버 측 방어 기술

실제 실습 중에 출석 기능 우회가 실패한 이유는 다음과 같은 **서버 측 보안 기술** 때문입니다.

### ✅ 1) TLS 핸드셰이크에서의 탐지

- 서버는 클라이언트와 SSL 연결을 맺기 전 `TLS Client Hello`를 주고받습니다.
- 이때 전송되는 암호화 방식, 버전 등에서 **브라우저 특유의 정보**가 전달되는데,
  Charles는 이를 완벽히 재현하지 못합니다.
- 결과적으로 서버는 **“이건 브라우저가 아니야”**라고 판단하고 연결을 끊습니다.
  - 대표 오류: `PROTOCOL_ERROR (0x1)`

### ✅ 2) SSL 인증서 위조 감지

- Charles는 실제 서버 대신 **자신의 SSL 인증서**를 클라이언트에 제공합니다.
- 일반 브라우저는 이를 수락할 수 있지만,
  서버는 **“이 인증서 내가 발급한 게 아닌데?”**라고 판단해 연결을 종료합니다.

### ✅ 3) 기타 고급 보안 기술

- **HTTP/2 전용 서버**는 Charles의 미지원으로 인해 연결이 차단될 수 있습니다.
- **HSTS (HTTP Strict Transport Security)** 적용 시, 브라우저는 **프록시를 통한 접속 자체를 차단**합니다.
- **JA3 Fingerprinting** 기법은 TLS 연결의 미세한 특징을 해시로 기록하여  
  **정상 브라우저가 아닌 경우(MITM 포함)** 차단할 수 있습니다.

---

## 4. Charles 사용 시 실습자 주의사항

1. **MITM용 인증서를 설치한 경우, 실습 후 반드시 삭제**해야 합니다.
2. **공용/외부 Wi-Fi 환경에서는 절대로 Charles 실행 금지**
3. **모바일 기기에 인증서를 설치한 경우**, 실습 종료 후 제거 필수

---

## 5. 핵심 개념 요약

| 용어 | 설명 |
|------|------|
| **Proxy** | 중간에서 요청을 가로채 전달하는 중계 서버 |
| **MITM (Man-in-the-Middle)** | 클라이언트와 서버 사이를 가로채 통신을 조작하는 방식 |
| **Charles** | HTTPS 트래픽을 해독하고 수정할 수 있는 프록시 도구 |
| **SSL / HTTPS** | 통신 내용을 암호화하여 보호하는 프로토콜 |
| **SSL Proxying** | HTTPS 트래픽을 중간에서 해독하기 위한 방식 |
| **Root CA 인증서** | 가짜 인증서 신뢰를 위해 브라우저에 추가하는 루트 인증서 |
| **User-Agent** | 클라이언트의 브라우저/기기 정보를 담은 헤더 |
| **Rewrite** | 요청/응답 헤더나 내용을 자동으로 변경하는 기능 |
| **TLS Handshake** | 클라이언트와 서버가 암호화 연결을 협상하는 단계 |
| **HSTS** | “무조건 HTTPS로만 접속하라”는 서버의 강제 정책 |
| **JA3 Fingerprinting** | TLS 연결 특성으로 비정상 클라이언트를 식별하는 기법 |
| **HTTP/2** | 최신 HTTPS 버전, 서버가 특정 버전만 강제 가능 |
| **UAC 경고** | 관리자 권한 상승 시 Windows에서 표시하는 보안 경고 |
| **PROTOCOL_ERROR (0x1)** | TLS/HTTP2 수준에서 연결이 강제 종료될 때 발생 |

---

## ✅ 최종 결론

- Charles는 네트워크 분석, 디버깅, 보안 실습에 매우 유용한 도구입니다.
- 다만 HTTPS 복호화를 시도하는 과정에서 서버 보안 정책에 의해 차단될 수 있으며,
  **기기와 인증서 관리에 대한 이해가 필수적**입니다.
- 실습은 합법적 목적 하에 이루어져야 하며, 보안 위험에 대한 충분한 인식이 선행되어야 합니다.
---

## 6. 보충 질문 정리 (Q&A)

### 🔹 Q1. React란 무엇인가?

**React**는 Facebook에서 만든 UI 라이브러리로, 컴포넌트 기반으로 웹앱을 구성합니다.  
SPA(Single Page Application) 구조에서 많이 사용되며, 빠르고 효율적인 UI 갱신을 제공합니다.

- **Virtual DOM**을 활용해 변경된 부분만 빠르게 렌더링합니다.
- **단방향 데이터 흐름**을 통해 예측 가능한 UI를 구성합니다.
- **컴포넌트 기반 구조**로 재사용성과 유지보수가 뛰어납니다.

💡 **비유**: React는 마치 **레고 블록처럼 UI를 조립**하는 방식입니다.  
하나의 블록(컴포넌트)이 바뀌면, 전체를 다시 만들지 않고 해당 블록만 교체됩니다.

---

### 🔹 Q2. `ua_patch.py`는 무슨 역할을 했나?

```python
def request(flow: http.HTTPFlow) -> None:
    flow.request.headers["User-Agent"] = (
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
        "AppleWebKit/537.36 (KHTML, like Gecko) "
        "Chrome/123.0.0.0 Safari/537.36"
    )
```

- mitmproxy에서 HTTP 요청을 가로채어, **User-Agent 값을 PC Chrome 브라우저로 변경**합니다.
- 서버는 이 값을 보고 "이건 모바일이 아니라 데스크탑이구나"라고 인식하게 됩니다.

💡 **비유**: 아이폰이 브라우저 요청을 보내면서 **“나 PC야”라고 위장하는 변조 장치**입니다.  
마치 **어린이가 어른 옷을 입고 영화관에 몰래 들어가는 것과 비슷**합니다.

---

### 🔹 Q3. Charles는 왜 `.py` 스크립트 없이도 조작이 가능한가?

- Charles는 **GUI 기반 툴**로, 요청/응답 조작을 메뉴 클릭만으로 설정할 수 있게 설계되었습니다.
- User-Agent 변경도 **Rewrite 설정**으로 가능하기 때문에 별도의 `.py` 스크립트가 필요하지 않았던 것.

| 구분 | Charles | mitmproxy |
|------|---------|------------|
| 설정 방식 | GUI 기반 메뉴로 조작 | Python 스크립트로 제어 |
| 사용자 친화성 | 높음 | 낮음 (CLI 기반) |
| 정밀 제어 | 제한적 | 매우 세밀하게 가능 |
| 자동화 | 제한됨 | 가능 (`flow` 제어) |
| HTTP/2 강제 조작 | ❌ 어려움 | ✅ 가능 (`--no-http2`) |

💡 **비유**: Charles는 **자동차 정비소처럼 버튼 몇 개만 누르면 되지만**,  
mitmproxy는 **직접 납땜하고 회로 조작까지 가능한 DIY 키트**입니다.

---